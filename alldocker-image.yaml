# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
  - none

parameters:
  - name: linux_package
    displayName: LinuxPackage
    type: string

  - name:  docker_image_creation
    displayName: DockerImageCreation
    type: string
    values:
      - None
      - All
      - Ubuntu
      - Debian
      - Alpine
      - Debian-Arm64
      - Ubuntu-Arm64
      - Alpine-Arm64

jobs:
  - job: DockerImagecreation
    displayName: 'Docker image creation'
    timeoutInMinutes: 0
    pool:
     vmImage: 'Ubuntu-latest'
    
    steps:
      - task: PowerShell@2
        inputs:
          targetType: 'inline'
          script: |
            sudo docker run --privileged --rm tonistiigi/binfmt --install all

      - task: PowerShell@2
        inputs:
          targetType: 'inline'
          script: |
            sudo docker buildx ls

      - task: Bash@3
        inputs:
          targetType: 'inline'
          script: |
            sudo wget '${{parameters.linux_package}}'
            sudo apt install unzip 
            sudo unzip BoldBIEnterpriseEdition_Linux_*
            IMAGE_TAG=$(echo "${{parameters.linux_package}}" | grep -oP 'Linux_Docker_\K[\d\.]+_\d{8}_\d{6}')
            echo "##vso[task.setvariable variable=TAG]$IMAGE_TAG"
            echo "Find the Tag: $TAG"

      - task: Docker@2
        inputs:
          containerRegistry: 'dockeimage-kings-test'
          repository: 'kingsleywills/scanning'
          command: 'buildAndPush'
          Dockerfile: BoldBIEnterpriseEdition-Linux/boldbi-debian.Dockerfile
          tags: |
            $(TAG)_Debian
        displayName: Docker push Debian Image

      - task: Docker@2
        inputs:
          containerRegistry: 'dockeimage-kings-test'
          repository: 'kingsleywills/scanning'
          command: 'buildAndPush'
          Dockerfile: BoldBIEnterpriseEdition-Linux/boldbi-ubuntu.Dockerfile
          tags: |
            $(TAG)_Ubuntu
        displayName: Docker push Ubuntu Image